<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<meta name="name" content="GOTO2015 - The Bottled Water Solution Landscape" />
	<meta name="description" content="A concept mapping of the bottled water solutions landscape"/>
	<meta name="mintags" content="2" />
	<meta name="maxtags" content="2" />
	<title>GOTO 2015 - Bottled Water</title>

<style>

//
// 
// (C) 2014 Dustin Spicuzza <dustin@virtualroadside.com>
//
// This work is licensed under the Creative Commons Attribution 4.0
// International License. To view a copy of this license, visit
// http://creativecommons.org/licenses/by/4.0/.
//
// Inspired by http://www.findtheconversation.com/concept-map/
// Loosely based on http://bl.ocks.org/mbostock/4063550
//

svg {
    font: 12px sans-serif;
}

text {
    pointer-events: none;
}

.inner_node rect {
    pointer-events: all;
    stroke-width: 0px;
}

.inner_node rect.highlight {
    stroke: #315B7E;
    stroke-width: 0px;
}

.inner_node rect.highlight_clicked {
    stroke: #315B7E;
    stroke-width: 0px;
}

.outer_node circle {
    fill: #fff;
    stroke: steelblue;
    stroke-width: 2px;
    pointer-events: all;
}

.outer_node circle.highlight
{
    stroke: #315B7E;
    stroke-width: 8px;
}

.outer_node circle.highlight_clicked
{
    stroke: #315B7E;
    stroke-width: 4px;
}


.link 
{
    fill: none;
}

h1 {
    display: table;
    font: 30px sans-serif;
    text-align: center;
    margin: 0 auto;
}

#mainDiagram {
    margin: 0 auto;
    text-align: center;
}

#descwindow {
    font: 15px sans-serif;
    text-align: center;
    margin: 0 auto;
    display: none;
    background-color: #ffffff;

}

#citeWindow {
    font: 15px sans-serif;
    text-align: center;
    margin: 0 auto;
}


</style>	
</head>
<body id="mainBody" bgcolor="#D9E9FF" style="width:960px">
    <div id="header" style="width:100%">
        <h1 >GOTO2015 - The Bottled Water Solution Landscape</h1>
    </div>
    <div id="mainDiagram" style="width:100%">
    </div>
    <div id="descwindow" style="width:600px;display:none">
        <h2 id="desctitle"></h2>
        <p id="descdesc"></p>
    </div>
    <div id="citeWindow" style="width:600px;display:block">
        <h2 id="citetitle">Bibliography <span id="citesymbol">[ + ]</span></h2>
        <p id="citedesc" style="width:600px;display:none">citation information</p>
    </div>
</body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>



var outer_data = [
["I", "Industry", "Industry ins an industry"],
["So", "Social", "Social is nice to have"],
["C", "Consumers", "Consumers consumer consumable consumables"],
["G", "Government", "Grrrrrr grovernment!"],
["Sp", "Substitutes", "Grr competition"],
["M", "Media", "Eve Binder"]
]


var inner_data = [
[["1" , "Government Solutions:", "Government", "Government initiatives to help reduce the impact of bottled water." ], []], 
[["4" , "Solution 1", "Government", "IpsoFacto blah blah blah blah" ], ["I", "C"]], 
[["5" , "Solution 2", "Government", "IpsoFacto blah blah blah blah" ], ["C", "G"]],
[["6" , "Solution 3", "Government", "IpsoFacto blah blah blah blah" ], ["C", "So", "G"]],

[["2" , "Social Solutions:", "Social", "Social forces that limit the impact of bottled water." ], []], 
[["7" , "Solution 4", "Social", "IpsoFacto blah blah blah blah" ], ["Sp", "G"]],
[["8" , "Solution 5", "Social", "IpsoFacto blah blah blah blah" ], ["Sp", "So", "G"]],
[["9" , "Solution 6", "Social", "IpsoFacto blah blah blah blah" ], ["I", "C", "G", "So", "Sp"]],

[["3" , "Economic Solutions:", "Economic", "Economic forces that help reduce the impact of bottled water." ], []], 
[["10" , "Solution 7", "Economic", "IpsoFacto blah blah blah blah" ], ["C", "G"]],
[["11" , "Solution 8", "Economic", "IpsoFacto blah blah blah blah" ], ["I", "C"]], 
[["12" , "Solution 9", "Economic", "IpsoFacto blah blah blah blah" ], ["C", "G"]],
[["13", "Solution 10", "Economic", "IpsoFacto blah blah blah blah" ], ["C", "So", "G", "M"]]
]


// transform the data into a useful representation
// 1 is inner, 2, is outer

// need: inner, outer, links
//
// inner: 
// links: { inner: outer: }


var outer = d3.map();
var inner = [];
var links = [];

var outerId = [0];

inner_data.forEach(function(d){
	
	if (d == null)
		return;
	
	i = { id:  'i' + d[0][0], name: d[0][1], type: d[0][2], desc: d[0][3], related_links: [] };
	i.related_nodes = [i.id];
	inner.push(i);
	
	if (!Array.isArray(d[1]))
		d[1] = [d[1]];
	
	d[1].forEach(function(d1){
		
        var d_curr = search_2d(d1, outer_data);

		o = outer.get(d_curr[1]); 
		
        if (o == null)
		{
			o = { name: d_curr[1],	id: 'o' + d_curr[0], desc: d_curr[2], related_links: [] };
			o.related_nodes = [o.id];
			outerId[0] = outerId[0] + 1;	
			
			outer.set(d_curr[1], o);
		}
		
		// create the links
		l = { id: 'l-' + i.id + '-' + o.id, inner: i, outer: o }
		links.push(l);
		
		// and the relationships
		i.related_nodes.push(o.id);
		i.related_links.push(l.id);
		o.related_nodes.push(i.id);
		o.related_links.push(l.id);
	});
});

data = {
	inner: inner,
	outer: outer.values(),
	links: links
}

// sort the data -- TODO: have multiple sort options
outer = data.outer;
data.outer = Array(outer.length);


var i1 = 0;
var i2 = outer.length - 1;

for (var i = 0; i < data.outer.length; ++i)
{
	if (i % 2 == 1)
		data.outer[i2--] = outer[i];
	else
		data.outer[i1++] = outer[i];
}

console.log(data.outer.reduce(function(a,b) { return a + b.related_links.length; }, 0) / data.outer.length);




var diameter = 800;
var total_height = 650;
var total_width = 960;
var rect_width = 150;
var rect_height = 20;
var circ_radius = 60;
var circ_deg_offset = 30
var circ_deg_squeeze = 15

var link_width = "2px"; 
var link_width_highlighted = "8px";

var il = data.inner.length;
var ol = data.outer.length;

var inner_y = d3.scale.linear()
    .domain([0, il])
    .range([-(il * rect_height)/2, (il * rect_height)/2]);

mid = (data.outer.length/2.0)

//rotational scalling for outer nodes
var outer_x = d3.scale.linear()
    .domain([0, mid, mid, data.outer.length])
    .range([circ_deg_offset + circ_deg_squeeze ,  
        180 + circ_deg_offset - circ_deg_squeeze*2, 
        180 + circ_deg_offset + circ_deg_squeeze , 
        360 + circ_deg_offset - circ_deg_squeeze*2]);



// setup positioning
data.outer = data.outer.map(function(d, i) { 
    d.x = outer_x(i);
    d.y = diameter/2.5;
    return d;
});

data.inner = data.inner.map(function(d, i) { 
    d.x = -(rect_width / 2);
    d.y = inner_y(i);
    return d;
});

// from d3 colorbrewer: http://colorbrewer2.org/
// This product includes color specifications and designs developed by Cynthia Brewer (http://colorbrewer.org/).

function get_color(name)
{
    var color = '#dddddd';
    switch(name) {
        case "Government":
            color =  "#fdc086";
            break;
        case "Social":
            color =  "#7fc97f";
            break;
        case "Economic":
            color =  "#beaed4";
            break;
            color = "#dddddd"
        }
    return color;
}

function search_2d(id, array)
{
    for (var i=0, len = array.length; i < len; i++) {
        if (array[i][0] === id) {
            return array[i];
        }
    }

    return null;
}

function search_3d(id, array)
{
    for (var i=0, len = array.length; i < len; i++) {
        if (array[i][0][0] === id) {
            return array[i][0];
        }
    }

    return null;
}

// Can't just use d3.svg.diagonal because one edge is in normal space, the
// other edge is in radial space. Since we can't just ask d3 to do projection
// of a single point, do it ourselves the same way d3 would do it.  

function projectX(x)
{
    return ((x - 90) / 180 * Math.PI) - (Math.PI/2);
}

var diagonal = d3.svg.diagonal()
    .source(function(d) { return {"x": d.outer.y * Math.cos(projectX(d.outer.x)), 
                                  "y": -d.outer.y * Math.sin(projectX(d.outer.x))}; })            
    .target(function(d) { return {"x": d.inner.y + rect_height/2,
                                  "y": d.outer.x > 180 ? d.inner.x : d.inner.x + rect_width}; })
    .projection(function(d) { return [d.y, d.x]; });


var svg = d3.select("#mainDiagram").append("svg")
    .attr("width", total_width)
    .attr("height", total_height)
  .append("g")
    .attr("transform", "translate(" + total_width / 2 + "," + ( total_height / 2 )  + ")");
    

// links
var link = svg.append('g').attr('class', 'links').selectAll(".link")
    .data(data.links)
  .enter().append('path')
    .attr('class', 'link')
    .attr('id', function(d) { return d.id })
    .attr("d", diagonal)
    .attr('stroke', function(d) { return get_color(d.inner.type); })
    .attr('stroke-width', link_width);

// outer nodes

var onode = svg.append('g').selectAll(".outer_node")
    .data(data.outer)
  .enter().append("g")
    .attr("class", "outer_node")
    .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
    .on("mouseover", mouseover)
    .on("mouseout", mouseout)
    .on("click", outernodeclick);
  
onode.append("circle")
    .attr('id', function(d) { return d.id })
    .attr("r", circ_radius);
  
onode.append("circle")
    .attr('r', circ_radius)
    .attr('visibility', 'hidden');
  
onode.append("text")
	.attr('id', function(d) { return d.id + '-txt'; })
    .attr("dy", ".31em")
    .attr("text-anchor", "middle")
    .attr("transform", function(d) { return "rotate(" + -(d.x - 90) + ")translate(0)"; })
    .attr("font-size", "1.2em")
    .attr("font-family", "sans-serif")
    .text(function(d) { return d.name; });
  
// inner nodes
  
var inode = svg.append('g').selectAll(".inner_node")
    .data(data.inner)
  .enter().append("g")
    .attr("class", "inner_node")
    .attr("transform", function(d, i) { return "translate(" + d.x +  "," + d.y + ")"})
    .on("mouseover", mouseover)
    .on("mouseout", mouseout)
    .on("click", innernodeclick);
  
inode.append('rect')
    .attr('width', rect_width)
    .attr('height', rect_height)
    .attr('id', function(d) { return d.id; })
    .attr('fill', function(d) { return get_color(d.type); });
  
inode.append("text")
	.attr('id', function(d) { return d.id + '-txt'; })
    .attr('text-anchor', 'middle')
    .attr("transform", "translate(" + rect_width/2 + ", " + rect_height * .75 + ")")
    .attr("font-size", "0.8em")
    .attr("font-family", "sans-serif")
    .text(function(d) { return d.name ; });

// need to specify x/y/etc

d3.select(self.frameElement).style("height", total_height + 0 + "px");

var mouseOverElement = false;
var clickedElement;

function mouseover(d)
{
    mouseOverElement = true;
    highlight(d, false);
}

function mouseout(d)
{   

    mouseOverElement = false;
    if (clickedElement === d)
        return;

    unhighlight(d, false);

}

function highlight(d, clicked)
{
    var highlighter = 'highlight';
    if (clicked)
        highlighter = 'highlight_clicked';

    // bring to front
    d3.selectAll('.links .link').sort(function(a, b){ return d.related_links.indexOf(a.id); }); 
    
    for (var i = 0; i < d.related_nodes.length; i++)
    {
        d3.select('#' + d.related_nodes[i]).classed(highlighter, true);
        d3.select('#' + d.related_nodes[i] + '-txt').attr("font-weight", 'bold');
    }
    
    for (var i = 0; i < d.related_links.length; i++) {
        var paths = d3.select('#' + d.related_links[i]);
        paths.classed(highlighter, true);
        paths.attr('stroke-width', link_width_highlighted);

    }
}

function unhighlight(d, clicked)
{
    var highlighter = 'highlight';
    if (clicked)
        highlighter = 'highlight_clicked';


    for (var i = 0; i < d.related_nodes.length; i++)
    {
        d3.select('#' + d.related_nodes[i]).classed(highlighter, false);
        d3.select('#' + d.related_nodes[i] + '-txt').attr("font-weight", 'normal');
    }
    
    for (var i = 0; i < d.related_links.length; i++) {
        var paths = d3.select('#' + d.related_links[i]);

        if (highlighter === 'highlight' ) {
            if (!( paths.classed('highlight_clicked'))) {
                paths.classed(highlighter, false);
                paths.attr('stroke-width', link_width);
            }
        }
        else {
            paths.classed(highlighter, false);
            paths.attr('stroke-width', link_width);
        }
        

    }
}

function innernodeclick(d) {
    nodeclick(d, true);
}


function outernodeclick(d) {
    nodeclick(d, false);
}

function nodeclick(d, inner)
{

   if (clickedElement) {
        unhighlight(clickedElement, true);
        unhighlight(clickedElement, false);
    }

    highlight(d, true);
    clickedElement = d;

    descbox = document.getElementById("descwindow");
    descboxtitle = document.getElementById("desctitle");
    descboxdesc = document.getElementById("descdesc");

    descboxtitle.innerHTML = d.name;

    var description = d.desc + '<br>';

    if (d.related_nodes.length > 1 && inner)
        description = description + "<br><b>Related Stakeholders:</b>"

    if (d.related_nodes.length > 1 && !inner)
        description = description + "<br><b>Related Solutions:</b>"

    for (var i=1; i < d.related_nodes.length; i++) {
        var node;
        
        if (inner) {
            node = String(d.related_nodes[i]).substring(1);
            node = search_2d(node, outer_data)[1];
            description = description + '<br>' + node;
        }
        else {
            node = String(d.related_nodes[i]).substring(1);
            node = search_3d(node, inner_data)[1];
            description = description + '<br>' + node;
        }
        
    }

    descboxdesc.innerHTML = description; 


    if (descbox.style.display === 'none')
        descbox.style.display = 'block';

}

function backgroundclick(d)
{

    if (mouseOverElement === true)
        return;

    if (clickedElement) {
        unhighlight(clickedElement, true);
        unhighlight(clickedElement, false);
    }


    descbox = document.getElementById("descwindow");

    if (descbox.style.display === 'block')
        descbox.style.display = 'none';
}

body = document.getElementById("mainBody");
body.setAttribute("onclick", "javascript:backgroundclick();");


function citeClick(d) {


    var citedesc = document.getElementById("citedesc");
    var citebox = document.getElementById("citeWindow")
    var citesymbol = document.getElementById("citesymbol");

    console.log(citebox);

    if (citedesc.style.display === 'none') {
        citedesc.style.display = 'block';
        citebox.style.backgroundColor = '#ffffff';
        citesymbol.innerHTML = "[ - ]";
    }
    else {
        citedesc.style.display = 'none';
        citebox.style.backgroundColor = 'transparent';
        citesymbol.innerHTML = "[ + ]";
    }
}

document.getElementById('citetitle').setAttribute("onclick", "javascript:citeClick();")

</script>


</html>